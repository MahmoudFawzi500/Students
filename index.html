<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Delta University | Student Exam Info</title>
<style>
    :root{
      --navy:#061a3a;
      --navy2:#04122a;

      --du-blue:#005FAA;
      --du-orange:#F15624;

      --card:#ffffff;
      --ink:#0b1220;
      --muted:#6b7280;
      --line:#e8ecf4;

      --ok:#0a7a2f;
      --danger:#b00020;

      --radius:22px;
      --shadow: 0 22px 60px rgba(0,0,0,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:28px;
      font-family: system-ui, "Segoe UI", Arial, sans-serif;
      color:var(--ink);

      background:
        radial-gradient(900px 600px at 20% 10%, rgba(0,95,170,.22), transparent 60%),
        radial-gradient(800px 600px at 85% 85%, rgba(241,86,36,.18), transparent 55%),
        linear-gradient(180deg, var(--navy), var(--navy2));
    }

    .card{
      width:min(480px, 96vw);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }

    .top{
      padding:16px 18px;
      position:relative;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #fbfcff);
    }
    .top::before{
      content:"";
      position:absolute;
      top:0; left:0; right:0;
      height:4px;
      background: linear-gradient(90deg, var(--du-blue), var(--du-orange));
    }

    .logoRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .logoImg{
      height:40px;
      width:auto;
      display:block;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:var(--du-blue);
      background:#f0f7ff;
      border:1px solid #d6ebff;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--du-orange);
      box-shadow:0 0 0 4px rgba(241,86,36,.18);
    }

    .body{ padding:18px; }

    .title{
      margin:0;
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .field{ position:relative; }

    input{
      width:100%;
      padding:14px 54px 14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:20px;
      letter-spacing:.7px;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    input:focus{
      border-color: rgba(0,95,170,.35);
      box-shadow: 0 0 0 6px rgba(0,95,170,.10);
    }

    .statusIcon{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:38px;height:38px;
      border-radius:14px;
      display:grid;
      place-items:center;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:1000;
      line-height:1;
      user-select:none;
    }
    .statusIcon.ok{
      color:var(--ok);
      background: rgba(10,122,47,.06);
      border-color: rgba(10,122,47,.18);
    }
    .statusIcon.err{
      color:var(--danger);
      background: rgba(176,0,32,.06);
      border-color: rgba(176,0,32,.18);
      font-size:24px;
    }

    .actions{ margin-top:12px; }

    button{
      width:100%;
      border:0;
      border-radius:16px;
      padding:13px 14px;
      font-size:14px;
      font-weight:1000;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, #005FAA, #0b74d6);
      box-shadow: 0 14px 26px rgba(0,95,170,.18);
      transition: transform .06s ease, filter .18s ease;
    }
    button:hover{ filter:brightness(1.03); }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      filter:saturate(.85);
    }

    .toast{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background:#f8fafc;
      color:var(--muted);
      font-size:13px;
      min-height:18px;

      opacity:0;
      transform: translateY(-4px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
    .toast.ok{ background: rgba(10,122,47,.06); border-color: rgba(10,122,47,.18); color: var(--ok); }
    .toast.err{ background: rgba(176,0,32,.06); border-color: rgba(176,0,32,.18); color: var(--danger); }

    .footer{
      padding:12px 18px 16px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, #ffffff, #fbfcff);
    }
    .footer b{ color:#111; }

    /* overlay */
    .overlay{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:999;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .overlayCard{
      width:min(360px, 92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:18px 16px;
      text-align:center;
    }
    .spinner{
      width:44px;height:44px;
      border-radius:50%;
      border:4px solid rgba(2,6,23,.10);
      border-top-color: var(--du-orange);
      animation: spin .85s linear infinite;
      margin:0 auto 10px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .overlayTitle{
      margin:0;
      font-weight:1000;
      font-size:14px;
      color:#111;
      letter-spacing:.2px;
    }
    .overlaySub{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
  

    /* ===== Result section (minimal addition, matches existing style) ===== */
    .result{ margin-top: 14px; }
    .resultCard{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 8px 26px rgba(17,24,39,.06);
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      font-weight: 800;
      color: var(--ink);
      letter-spacing: .2px;
    }
    .badge{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--ink);
      white-space: nowrap;
    }
    .bNeutral{ background: rgba(31,41,55,.04); }
    .bOk{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25); }
    .bEarly{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25); }
    .bLate{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); }

    .kvGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 520px){
      .kvGrid{ grid-template-columns: 1fr 1fr; }
    }
    .kv{ border:1px solid var(--line); border-radius: 14px; padding: 10px 12px; background: rgba(255,255,255,.75); }
    .kv .k{ font-size: 12px; font-weight: 800; color: var(--muted); margin-bottom: 4px; }
    .kv .v{ font-size: 14px; font-weight: 800; color: var(--ink); }

    .divider{ height:1px; background: var(--line); margin: 12px 0; }

    .tableWrap{ overflow-x:auto; border:1px solid var(--line); border-radius: 14px; background: rgba(255,255,255,.85); }
    .examTable{
      width:100%;
      border-collapse: collapse;
      min-width: 620px;
    }
    .examTable th, .examTable td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      vertical-align: middle;
      font-weight: 800;
      color: var(--ink);
      white-space: nowrap;
    }
    .examTable th{
      background: rgba(17,24,39,.04);
      font-size: 12px;
      color: #111827;
    }
    .examTable td{ font-size: 13px; }
    .examTable tr:last-child td{ border-bottom: none; }

    .mutedLine{ color: var(--muted); font-weight: 800; }

    /* Toast warning state */
    .toast.warn{ border-color: rgba(245,158,11,.35); color: #92400e; background: rgba(245,158,11,.10); }

    .disclaimer {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.55);
      font-size: 12.5px;
      line-height: 1.35;
      color: rgba(0,0,0,.78);
    }
    .disclaimer b { font-weight: 800; }
    
</style>
</head>
<body>
<div class="card">
<div class="top">
<div class="logoRow">
<img alt="Delta University logo" class="logoImg" src="logo.png" onerror="this.style.display='none'"/>
<div class="chip"><span class="dot"></span> Student Exam Info</div>
</div>
</div>
<div class="body">
<p class="title">Student ID</p>
<p class="sub">Enter your ID to view your next exam details.</p>
<div class="field">
<input autocomplete="off" id="sid" inputmode="numeric" placeholder="e.g. 9211005"/>
<div aria-hidden="true" class="statusIcon" id="icon">—</div>
</div>
<div class="actions">
<button disabled="" id="openBtn">Open</button>
</div>
<div aria-live="polite" class="toast" id="toast" role="status"></div><div class="result" hidden="" id="result"></div>
</div>

<div class="disclaimer" dir="rtl"><b>تنبيه:</b> هذه الصفحة لخدمة الطلاب فقط. الطالب مُلزم بالمواعيد وأماكن الامتحان المُعلنة رسميًا من مكتب وكيل وعميد الكلية، وأي اختلاف يُعتد فيه بالإعلان الرسمي.</div>
<div class="footer">
<span><b>Tip:</b> Press Enter</span>
<span>Shows: <b>Next exam only</b> · <span id="timeSrc"></span></span>
</div>
</div>
<div aria-hidden="true" class="overlay" id="overlay">
<div class="overlayCard">
<div class="spinner"></div>
<p class="overlayTitle">Loading…</p>
<p class="overlaySub">Please wait</p>
</div>
</div>
<script>
  const DB_DIR = "Json database";


// =========================
// Time source (server Date header when possible)
// =========================
let __timeSource = "device";

/**
 * Returns a Date object representing "now".
 * - On https/http (GitHub Pages), it prefers the server time from the HTTP Date header.
 * - On file:// offline mode, falls back to device time (no reliable headers).
 */
async function getNowSmart() {
  const proto = location.protocol;
  if (proto === "http:" || proto === "https:") {
    // Prefer the hosting server time (harder to spoof than device clock)
    const candidates = [
      `${DB_DIR}/config.json`,
      location.href
    ];
    for (const url of candidates) {
      try {
        const res = await fetch(url, { method: "GET", cache: "no-store" });
        const dh = res.headers.get("date");
        if (dh) {
          const dt = new Date(dh);
          if (!isNaN(dt.getTime())) {
            __timeSource = "server";
            return dt;
          }
        }
      } catch (e) {
        // ignore and try next candidate
      }
    }
  }
  __timeSource = "device";
  return new Date();
}



function updateTimeSourceUI() {
  const el = document.getElementById("timeSrc");
  if (el) el.textContent = `Time: ${getTimeSourceLabel()}`;
}

function getTimeSourceLabel() {
  return __timeSource === "server" ? "Server time" : "Device time";
}
 // folder next to index.html
  let CONFIG = null;

  // If you open this file directly (file://), browsers block fetch() from local JSON.
  // To test locally WITHOUT a server, we ask once to pick the 'Json database' folder.
  const LOCAL_FILES = new Map();
  let LOCAL_READY = false;

  async function ensureLocalDB(){
    if(LOCAL_READY) return;

    // 1) Modern browsers (Chromium): directory picker
    if(window.showDirectoryPicker){
      try{
        toast("Offline mode: select the 'Json database' folder once.", "warn", true);
        const dir = await window.showDirectoryPicker({ mode: "read" });
        for await (const [name, handle] of dir.entries()){
          if(handle.kind === "file"){
            const file = await handle.getFile();
            LOCAL_FILES.set(name, file);
          }
        }
        LOCAL_READY = LOCAL_FILES.size > 0;
        if(LOCAL_READY) return;
      }catch(e){
        // user cancelled -> fall through to file input
      }
    }

    // 2) Fallback: <input webkitdirectory> (works in Chrome/Edge)
    await new Promise((resolve) => {
      toast("Offline mode: choose the 'Json database' folder.", "warn", true);
      const input = document.createElement("input");
      input.type = "file";
      input.multiple = true;
      input.setAttribute("webkitdirectory", "");
      input.style.display = "none";
      document.body.appendChild(input);

      input.addEventListener("change", () => {
        const files = Array.from(input.files || []);
        for(const f of files){
          const rel = f.webkitRelativePath || f.name;
          const parts = rel.split("/");
          const name = parts[parts.length - 1];
          LOCAL_FILES.set(name, f);
        }
        LOCAL_READY = LOCAL_FILES.size > 0;
        input.remove();
        resolve();
      }, { once: true });

      input.click();
    });

    if(!LOCAL_READY){
      throw new Error("LOCAL_DB_NOT_SELECTED");
    }
  }


  function normalizeDigits(s){
    const ar = "٠١٢٣٤٥٦٧٨٩";
    return (s||"").replace(/[٠-٩]/g, d => String(ar.indexOf(d)));
  }

  const sidEl = document.getElementById("sid");
  const iconEl = document.getElementById("icon");
  const toastEl = document.getElementById("toast");
  const openBtn = document.getElementById("openBtn");
  const overlay = document.getElementById("overlay");
  const resultEl = document.getElementById("result");

  function setToast(text, type=""){
    toastEl.textContent = text || "";
    toastEl.className = "toast " + (text ? "show " : "") + type;
  }

  function showOverlay(show){
    overlay.classList.toggle("show", !!show);
  }

  function cleanAndGetId(){
    const raw = normalizeDigits(sidEl.value);
    const digitsOnly = raw.replace(/[^\d]/g, "");
    if(sidEl.value !== digitsOnly) sidEl.value = digitsOnly;

    if(!digitsOnly) return null;
    if(!/^\d{4,12}$/.test(digitsOnly)) return "fault";
    return digitsOnly;
  }

  function formatInTZ(iso, tz, kind){
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "";
    if(kind === "date"){
      return d.toLocaleDateString("en-GB", { timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit" });
    }
    return d.toLocaleTimeString("en-GB", { timeZone: tz, hour:"2-digit", minute:"2-digit" });
  }

  function setIcon(state){
    if(state === "ok"){
      iconEl.className = "statusIcon ok";
      iconEl.textContent = "✓";
    }else if(state === "err"){
      iconEl.className = "statusIcon err";
      iconEl.textContent = "✕";
    }else{
      iconEl.className = "statusIcon";
      iconEl.textContent = "—";
    }
  }

  function hideResult(){
    resultEl.hidden = true;
    resultEl.innerHTML = "";
  }

  function renderResult(student, exam, mode, msg){
    const badgeClass = mode === "ok" ? "bOk" : (mode === "late" ? "bLate" : (mode === "none" ? "bNeutral" : "bEarly"));
    const badgeText  = mode === "ok" ? "AVAILABLE" : (mode === "late" ? "CLOSED" : (mode === "none" ? "INFO" : "TOO EARLY"));

    const safe = (v)=> (v===null || v===undefined || v==="") ? "—" : String(v);

    const tz = (CONFIG && CONFIG.timezone) ? CONFIG.timezone : "Africa/Cairo";

    let examHTML = "";
    if(exam === null){
      examHTML = `
        <div class="sectionHead">
          <div class="sectionTitle">Next Exam</div>
          <div class="badge ${badgeClass}">${badgeText}</div>
        </div>
        <div class="mutedLine">${msg || "No upcoming exams."}</div>
      `;
    }else{
      const date = formatInTZ(exam.examStartISO, tz, "date");
      const t1 = formatInTZ(exam.examStartISO, tz, "time");
      const t2 = formatInTZ(exam.examEndISO, tz, "time");
      const time = (t1 && t2) ? `${t1} – ${t2}` : (t1 || "—");

      const showSeat = (mode === "ok");
      const showLoc  = (mode === "ok");

      const seat = showSeat ? safe(exam.seat) : "Hidden";
      const loc  = showLoc  ? safe(exam.location) : "Hidden";

      examHTML = `
        <div class="sectionHead">
          <div class="sectionTitle">Next Exam</div>
          <div class="badge ${badgeClass}">${badgeText}</div>
        </div>
        <div class="tableWrap" role="region" aria-label="Next exam table">
          <table class="examTable">
            <thead>
              <tr>
                <th>Course</th>
                <th>Code</th>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Seat</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${safe(exam.courseName)}</td>
                <td><b>${safe(exam.courseCode)}</b></td>
                <td>${safe(date)}</td>
                <td><b>${safe(time)}</b></td>
                <td>${loc}</td>
                <td>${seat}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }

    resultEl.innerHTML = `
      <div class="resultCard">
        <div class="sectionHead">
          <div class="sectionTitle">Student Info</div>
          <div class="badge bNeutral">ID: ${safe(student.id)}</div>
        </div>

        <div class="kvGrid">
          <div class="kv"><div class="k">Name</div><div class="v">${safe(student.name)}</div></div>
          <div class="kv"><div class="k">Semester</div><div class="v">${safe(student.semester)}</div></div>
          <div class="kv"><div class="k">Academic Year</div><div class="v">${safe(student.academicYear)}</div></div>
        </div>

        <div class="divider"></div>
        ${examHTML}
      </div>
    `;
    resultEl.hidden = false;

    if(msg){
      setToast(msg, mode === "ok" ? "ok" : (mode === "late" ? "err" : (mode === "none" ? "ok" : "warn")));
    }
  }

  async function fetchJSON(url){
    // Supports both GitHub Pages (http/https) and local file opening (file://)
    if(location.protocol === "file:"){
      await ensureLocalDB();
      const name = (url||"").split("/").pop();
      const f = LOCAL_FILES.get(name);
      if(!f) throw new Error("FILE_NOT_FOUND " + name);
      const txt = await f.text();
      return JSON.parse(txt);
    }

    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  }

  async function loadConfig(){
    try{
      CONFIG = await fetchJSON(`${DB_DIR}/config.json`);
      return true;
    }catch(_){
      CONFIG = null;
      return false;
    }
  }

  function updateUI(){
    const id = cleanAndGetId();

    if(id === null){
      setIcon("none");
      openBtn.disabled = true;
      setToast("", "");
      hideResult();
      return;
    }

    if(id === "fault"){
      setIcon("err");
      openBtn.disabled = true;
      setToast("❌ ID is invalid. Please enter 4–12 digits only.", "err");
      hideResult();
      return;
    }

    // Valid format → wait for DB existence check
    __idExists = false;
    openBtn.disabled = true;
    setIcon("idle");
    setToast("", "");

    // Live existence check: red if not found, green if found
    debouncedCheckId(id);

    setIcon("ok");
    openBtn.disabled = false;
    setToast("Ready. Click Open.", "ok");
  }

  async function openPaper(){
    const id = cleanAndGetId();

    if(id === null || id === "fault"){
      setToast("❌ Please enter a valid Student ID.", "err");
      sidEl.focus();
      return;
    }


    // Require ID to exist in DB (green) before allowing Open
    if(!__idExists){
      setIcon("err");
      setToast("❌ Student ID not found.", "err");
      hideResult();
      return;
    }

    showOverlay(true);
    openBtn.disabled = true;
    setToast("Loading…", "ok");

    await new Promise(r => setTimeout(r, 350));

    if(CONFIG === null) await loadConfig();

    const messages = (CONFIG && CONFIG.messages) ? CONFIG.messages : {};
    const releaseHrs = (CONFIG && Number.isFinite(CONFIG.releaseWindowHours)) ? CONFIG.releaseWindowHours : 16;
    const closeAtStart = (CONFIG && typeof CONFIG.closeAtExamStart === "boolean") ? CONFIG.closeAtExamStart : true;

    try{
      const student = await fetchJSON(`${DB_DIR}/${id}.json`);
      student.id = student.id || id;

      if(!("nextExam" in student) || student.nextExam === null){
        setIcon("ok");
        renderResult(student, null, "none", messages.noUpcoming || "✅ No upcoming exams.");
        return;
      }

      const exam = student.nextExam;
      const start = new Date(exam.examStartISO);
      const now = await getNowSmart();
  updateTimeSourceUI();

      if(Number.isNaN(start.getTime())){
        setIcon("err");
        setToast("❌ Invalid exam date in database.", "err");
        hideResult();
        return;
      }

      const releaseTime = new Date(start.getTime() - releaseHrs * 3600 * 1000);

      if(now.getTime() < releaseTime.getTime()){
        setIcon("ok");
        renderResult(student, exam, "early", messages.tooEarly || "⏳ Seat & location will appear 16 hours before your exam.");
        return;
      }

      if(closeAtStart && now.getTime() >= start.getTime()){
        setIcon("err");
        renderResult(student, exam, "late", messages.tooLate || "⛔ Exam started. Access closed.");
        return;
      }

      setIcon("ok");
      renderResult(student, exam, "ok", messages.ok || "✅ Available now.");
    }catch(err){
      setIcon("err");
      hideResult();
      const is404 = String(err && err.message || "").includes("HTTP 404");
      const msg = is404 ? (messages.notFound || "❌ Student ID not found.") : "❌ Database unavailable. Please try again later.";
      setToast(msg, "err");
    }finally{
      showOverlay(false);
      openBtn.disabled = false;
    }
  }

  sidEl.addEventListener("input", updateUI);
  sidEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter") openPaper(); });
  openBtn.addEventListener("click", openPaper);

  loadConfig();
  updateUI();
</script>
</body>
</html>
